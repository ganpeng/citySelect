/**
 * citySelect, a jQuery plugin
 * Author TonyLevid
 * Version 0.2
 * 城市选择
 * @param string provSelector jquery选择器, 省份目标元素, 为null则不选择
 * @param string citySelector jquery选择器, 城市目标元素, 为null则不选择
 * @param string distSelector jquery选择器, 区县目标元素, 为null则不选择
 * @param json citySelectOptions citySelect配置
 */
(function(e){var t={};e.citySelect=function(n,r,i,s){function u(t){if(e.browser.msie&&parseInt(e.browser.version)<7){e(t).each(function(){this.offsetWidth})}}function a(t){var s=o.jsonAreasMainKeysMap.prov;var a=o.jsonAreasMainKeysMap.city;var f=o.jsonAreasMainKeysMap.dist;var l=o.jsonAreasSubKeysMap.id;var c=o.jsonAreasSubKeysMap.pid;var h=o.jsonAreasSubKeysMap.name;if(!o.withParentFirst){var p={};e.each([t[s],t[a],t[f]],function(e,t){p[l]=0;p[c]=0;p[h]="--";if(typeof t!="undefined"){var n=t.slice(0,1);var r=n.shift();r[l]!=0&&t.unshift(p)}})}var d=function(){if(n){var r="";o.withParentFirst&&(r='<option value="'+0+'" name="'+o.jsonEmptyReplaceStr.prov+'">'+o.jsonEmptyReplaceStr.prov+"</option>");e.each(t[s],function(e,t){parseInt(t[l])||(t[h]=o.jsonEmptyReplaceStr.prov);r+='<option value="'+t[l]+'" name="'+t[h]+'">'+t[h]+"</option>"});if(r){e(n).show();e(n).html(r);u(n)}else{e(n).html('<option value=""></option>').hide()}}};var v=function(n){if(r){var i="";var s=n==0?o.jsonEmptyReplaceStr.city:o.jsonWithParentReplaceStr.city;o.withParentFirst&&(i='<option value="'+n+'" name="'+s+'">'+s+"</option>");e.each(t[a],function(e,t){if(t[c]==n){parseInt(t[l])||(t[h]=o.jsonEmptyReplaceStr.city);i+='<option value="'+t[l]+'" name="'+t[h]+'">'+t[h]+"</option>"}});if(i){e(r).show();e(r).html(i);u(r)}else{e(r).html('<option value=""></option>').hide()}}};var m=function(n){if(i){var r="";var s=n==0?o.jsonEmptyReplaceStr.dist:o.jsonWithParentReplaceStr.dist;o.withParentFirst&&(r='<option value="'+n+'" name="'+s+'">'+s+"</option>");e.each(t[f],function(e,t){if(t[c]==n){parseInt(t[l])||(t[h]=o.jsonEmptyReplaceStr.dist);r+='<option value="'+t[l]+'" name="'+t[h]+'">'+t[h]+"</option>"}});if(r){e(i).show();e(i).html(r);u(i)}else{e(i).html('<option value=""></option>').hide()}}};var g=function(){var t={};t[s]={};t[s][l]=parseInt(e(n).val());t[s][h]=e(n).find("option").filter(":selected").attr("name");t[a]={};t[a][l]=parseInt(e(r).val());t[a][h]=e(r).find("option").filter(":selected").attr("name");t[f]={};t[f][l]=parseInt(e(i).val());t[f][h]=e(i).find("option").filter(":selected").attr("name");return t};var y=function(t,s,o){e(n).find('option[value="'+t+'"]').prop("selected","selected").end().change();e(r).find('option[value="'+s+'"]').prop("selected","selected").end().change();e(i).find('option[value="'+o+'"]').prop("selected","selected")};var b=function(o,u){var c="";if(o==n&&n){c=t[s]}else if(o==r&&r){c=t[a]}else if(o==i&&i){c=t[f]}else{c={}}var p=null;e.each(c,function(e,t){if(t[l]==u||u&&t[h].match(u)){p=t[l];return false}});return p};var w=true;d();e(n).on("change",function(){e(n).val(e(this).val());v(e(this).val());m(e(r).val());if(!w){typeof o.afterChange=="function"&&o.afterChange(g())}});e(r).on("change",function(){e(r).val(e(this).val());m(e(this).val());if(!w){typeof o.afterChange=="function"&&o.afterChange(g())}});e(i).on("change",function(){e(i).val(e(this).val());if(!w){typeof o.afterChange=="function"&&o.afterChange(g())}});if(o.initByIp==="server"&&o.jsonServerIp){e.getScript(o.jsonServerIp,function(){var e=remote_ip_info;var t=b(n,e[o.jsonServerIpKeysMap.prov]);var s=b(r,e[o.jsonServerIpKeysMap.city]);var u=b(i,e[o.jsonServerIpKeysMap.dist]);y(t,s,u);typeof o.afterInit=="function"&&o.afterInit(g());w=false})}else if(o.initByIp==="client"&&o.jsonClientIp){e.getScript(o.jsonClientIp,function(){var e=remote_ip_info;var t=b(n,e[o.jsonClientIpKeysMap.prov]);var s=b(r,e[o.jsonClientIpKeysMap.city]);var u=b(i,e[o.jsonClientIpKeysMap.dist]);y(t,s,u);typeof o.afterInit=="function"&&o.afterInit(g());w=false})}else{var E=b(n,o.initProv);var S=b(r,o.initCity);var x=b(i,o.initDist);y(E,S,x);typeof o.afterInit=="function"&&o.afterInit(g());w=false}}var o=e.extend({},e.citySelect.defaults,s);var f=o.jsonAreas.replace(/\/+$/,"").split("/");var l=f[f.length-1];if(e.isEmptyObject(t[l])){e.getScript(o.jsonAreas,function(){var e=citySelectMainData;t[l]=e;a(e)})}else{a(t[l])}};e.citySelect.defaults={jsonAreas:"./plugins/areas.json.js",jsonServerIp:"",jsonClientIp:"http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js",initByIp:null,initProv:null,initCity:null,initDist:null,withParentFirst:false,afterInit:function(t){},afterChange:function(t){},jsonEmptyReplaceStr:{prov:"请选择省份",city:"请选择城市",dist:"请选择地区"},jsonWithParentReplaceStr:{city:"全省",dist:"全市"},jsonAreasMainKeysMap:{prov:"prov",city:"city",dist:"dist"},jsonAreasSubKeysMap:{id:"i",pid:"p",name:"n"},jsonServerIpKeysMap:{prov:"province",city:"city",dist:"district"},jsonClientIpKeysMap:{prov:"province",city:"city",dist:"district"}}})(jQuery)